/*! ImageRazor 25-07-2015 */
!function(a,b,c){"use strict";function d(a,b){var c;if(void 0===a)return b;for(c in b)b.hasOwnProperty(c)&&a.hasOwnProperty(c)===!1&&(a[c]=b[c]);return a}var e=function(a){if(!this||"[object Object]"!=this.toString())return new e(a);a=a||a,a.wrapper="string"==typeof a.wrapper?b.querySelector(a.wrapper):a.wrapper;var c={imageSize:"asItIs",editor:{width:400,height:300,backgroundColor:"#000",cropAreaBorderColor:"#A5A5A5",cropAreaBorderWidth:1,cropAreaBorderDashStep:7,cropAreaSize:{width:200,height:200}},format:"dataURL",saveCallback:function(){},closeCallback:function(){}};a.editor=a.editor||{},a.editor=d(a.editor,c.editor),this.options=d(a,c),this.init()};e.prototype.init=function(){var a=this.options.wrapper,d=this,e=b.createElement("div");e.className="image-razor-splashscreen",a.appendChild(e);var f=b.createElement("div");f.className="image-razor-box",f.setAttribute("style","width: "+this.options.editor.width+"px"),a.appendChild(f);var g=b.createElement("div");g.className="image-razor-toolbox",g.addEventListener("click",function(a){d.handleToolsBox(a)});var h=b.createElement("div");h.className="image-razor-toolbox-item icon-rotate-ccw",h.setAttribute("data-name","RotateCCWise"),g.appendChild(h);var h=b.createElement("div");h.className="image-razor-toolbox-item icon-rotate-cw",h.setAttribute("data-name","RotateCWise"),g.appendChild(h);var h=b.createElement("div");h.className="image-razor-toolbox-item icon-eye",h.setAttribute("data-name","EffectGrayscale"),g.appendChild(h);var h=b.createElement("div");h.className="image-razor-toolbox-item icon-cancel",h.setAttribute("data-name","Close"),g.appendChild(h);var h=b.createElement("div");h.className="image-razor-toolbox-item icon-done",h.setAttribute("data-name","Save"),g.appendChild(h),f.appendChild(g);var i=b.createElement("canvas"),j=b.createElement("div");j.className="image-razor-canvas-container",j.appendChild(i),f.appendChild(j),this.canvas=new c.Canvas(i,{selection:!1,width:this.options.editor.width,height:this.options.editor.height,backgroundColor:this.options.editor.backgroundColor}),this.initCanvasElements()},e.prototype.initCanvasElements=function(){this.canvasElements={image:null,cropArea:null},this.canvasAddElements()},e.prototype.canvasReset=function(){this.canvas.clear(),this.initCanvasElements()},e.prototype.canvasAddElements=function(){var a=this;this.canvasAddImage(function(){a.canvasAddCropArea()})},e.prototype.canvasAddImage=function(a){var b=this;this.canvasElements.image=new c.Image.fromURL(this.options.src,function(c){var d;b.canvas.add(c),b.srcImageSize={width:c.width,height:c.height},d=b.calcImageSize(c.width,c.height),c.setWidth(d.width).setHeight(d.height).center().setCoords().moveTo(-1),c.evented=!1,b.canvasElements.image=c,a()},{crossOrigin:!0})},e.prototype.canvasAddCropArea=function(){var a,b,e={borderColor:this.options.editor.cropAreaBorderColor,cornerColor:this.options.editor.cropAreaBorderColor,borderDashStep:this.options.editor.cropAreaBorderDashStep,borderWidth:this.options.editor.cropAreaBorderWidth,restrict:this.getRestrictCropArea()};if("object"==typeof this.options.imageSize){var f=this.calcCropAreaSize();b={width:f.width,height:f.height,hasControls:!1}}else b={width:this.options.editor.cropAreaSize.width,height:this.options.editor.cropAreaSize.height};b=d(b,e),a=new c.cropArea(b),this.canvas.add(a),a.center().setCoords(),a.setControlsVisibility({mtr:!1}),this.canvasElements.cropArea=a},e.prototype.calcCropAreaSize=function(){var a,b;return this.canvasElements.image.width!=this.canvas.width?(a=this.canvasElements.image.width,b=Math.round(this.options.imageSize.height/this.options.imageSize.width*a)):(b=this.canvasElements.image.height,a=Math.round(this.options.imageSize.width/this.options.imageSize.height*b)),{width:a,height:b}},e.prototype.saveToDataURL=function(){var a,b;return a="object"==typeof this.options.imageSize?this.options.imageSize.width/this.canvasElements.image.width:"original"==this.options.imageSize?this.srcImageSize.width/this.canvasElements.image.width:1,this.canvasElements.cropArea.hide(),b=this.canvas.toDataURL({left:this.canvasElements.cropArea.left,top:this.canvasElements.cropArea.top,width:this.canvasElements.cropArea.width,height:this.canvasElements.cropArea.height,multiplier:a}),this.canvasElements.cropArea.show(),b},e.prototype.saveToBlob=function(){for(var a=this.saveToDataURL(),b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob(e,{type:c})},e.prototype.calcImageSize=function(a,b){var c,d,e=this.canvas.width,f=this.canvas.height,g=a/b;return d=1*f,c=g*d,c>e&&(c=1*e,d=Math.round(c/g)),{width:c,height:d}},e.prototype.getRestrictCropArea=function(){return{x1:this.canvasElements.image.left,y1:this.canvasElements.image.top,x2:this.canvasElements.image.left+this.canvasElements.image.width,y2:this.canvasElements.image.top+this.canvasElements.image.height}},e.prototype.handleToolsBox=function(a){var b=a.target.getAttribute("data-name"),c="toolBoxHandler"+b;this[c]()},e.prototype.close=function(){this.destroy(),this.options.closeCallback()},e.prototype.destroy=function(){for(var a=this.options.wrapper;a.firstChild;)a.removeChild(a.firstChild)},e.prototype.toolBoxHandlerSave=function(){var a;a="blob"==this.options.format?this.saveToBlob():this.saveToDataURL(),this.options.saveCallback(a),this.destroy()},e.prototype.toolBoxHandlerClose=function(){this.close()},e.prototype.toolBoxHandlerRotateCWise=function(){this.rotateImage(1)},e.prototype.toolBoxHandlerRotateCCWise=function(){this.rotateImage(-1)},e.prototype.toolBoxHandlerEffectGrayscale=function(){0==this.canvasElements.image.filters.length?this.canvasElements.image.filters.push(new c.Image.filters.Grayscale):this.canvasElements.image.filters.pop(),this.canvasElements.image.applyFilters(this.canvas.renderAll.bind(this.canvas))},e.prototype.rotateImage=function(a){a=a||-1;var c;this.canvasElements.cropArea.hide(),c=this.canvas.toDataURL({left:this.canvasElements.image.left,top:this.canvasElements.image.top,width:this.canvasElements.image.width,height:this.canvasElements.image.height,multiplier:this.srcImageSize.width/this.canvasElements.image.width});var d=this,e=b.createElement("canvas"),f=e.getContext("2d"),g=new Image;g.onload=function(){e.setAttribute("width",g.height),e.setAttribute("height",g.width),f.translate(e.width/2,e.height/2),f.rotate(90*a*Math.PI/180),f.drawImage(g,-g.width/2,-g.height/2);var b=e.toDataURL();d.options.src=b,d.canvas.clear(),d.initCanvasElements()},g.src=c},c.cropArea=c.util.createClass(c.Rect,{initialize:function(a){a.fill="rgba(0,0,0,0)",a.hasBorders=!1,this.callSuper("initialize",a);var b=a.restrict;b&&(this.on("moving",function(){var a=this.getLeft(),c=this.getTop(),d=a+this.getWidth(),e=c+this.getHeight();a<b.x1&&this.setLeft(b.x1),c<b.y1&&this.setTop(b.y1),d>b.x2&&this.setLeft(b.x2-this.getWidth()),e>b.y2&&this.setTop(b.y2-this.getHeight())}),this.on("scaling",function(){var a=this.getLeft(),c=this.getTop(),d=a+this.getWidth(),e=c+this.getHeight();if(this.width=Math.round(this.width*this.scaleX),this.height=Math.round(this.height*this.scaleY),this.scaleX=1,this.scaleY=1,a<b.x1){var f=b.x1-a;this.setLeft(b.x1),this.setWidth(this.width-f)}if(c<b.y1){var g=b.y1-c;this.setTop(b.y1),this.setHeight(this.height-g)}if(d>b.x2){var f=d-b.x2;this.setWidth(this.width-f)}if(e>b.y2){var g=e-b.y2;this.setHeight(this.height-g)}}))},_render:function(a){this.callSuper("_render",a);var b=-1*Math.ceil(this.left+this.width/2),c=-1*Math.ceil(this.top+this.height/2);a.save(),a.translate(b,c);var d=0,e=this.left,f=this.left+this.width,g=this.canvas.width,h=0,i=this.top,j=this.top+this.height,k=this.canvas.height;a.fillStyle="rgba(0, 0, 0, 0.5)",a.fillRect(d,h,g,i),a.fillRect(d,j,g,k-j),a.fillRect(d,i,e-d,j-i),a.fillRect(f,i,g-f,j-i),a.strokeStyle=this.borderColor,a.lineWidth=this.borderWidth,a.beginPath(),this.drawDashLine(e,i,e,j,a),this.drawDashLine(e,j,f,j,a),this.drawDashLine(f,j,f,i,a),this.drawDashLine(f,i,e,i,a),a.stroke(),a.restore()},hide:function(){this.set({opacity:0,selectable:!1})},show:function(){this.set({opacity:1,selectable:!0})},drawDashLine:function(a,b,c,d,e,f){void 0==f&&(f=this.borderDashStep),e.moveTo(a,b);for(var g=c-a,h=d-b,i=Math.floor(Math.sqrt(g*g+h*h)/f),j=g/i,k=h/i,l=0;l++<i;)a+=j,b+=k,e[l%2==0?"moveTo":"lineTo"](a,b);e[l%2==0?"moveTo":"lineTo"](c,d)}}),e.VERSION="0.0.1",a.ImageRazor=e}(window,document,fabric);